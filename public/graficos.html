<!DOCTYPE html>
<html>
<head>
  <title>Gráficos</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body{
      display: flex;
      flex-direction: column;
      max-width: 100%;
      width: 95%;
      justify-content: center;
      align-content: center;
    }
    .quadrado{
      overflow-y: scroll;
      max-width: 100%;
      width: 100%;
      height: 33rem;

    }
    .chart-container {
      margin-bottom: 20px;
      max-width: 70%;
      width: 100%;
    }
  </style>
</head>
<body>
  <h1>Gráficos por Mês</h1>
  <div>
    <button><a href="mapa.html">Voltar para o Mapa</a></button>
  </div>

  <div>
    <label for="monthSelect">Selecione o mês:</label>
    <select id="monthSelect">
      <option value="">Todos os meses</option>
      <option value="01">Janeiro</option>
      <option value="02">Fevereiro</option>
      <option value="03">Março</option>
      <option value="04">Abril</option>
      <option value="05">Maio</option>
      <option value="06">Junho</option>
      <option value="07">Julho</option>
      <option value="08">Agosto</option>
      <option value="09">Setembro</option>
      <option value="10">Outubro</option>
      <option value="11">Novembro</option>
      <option value="12">Dezembro</option>
    </select>
  </div>

  <div class="quadrado"><div id="chartContainer"></div></div>

  <script>
    let chartData = {}; // Variável global para armazenar os dados do gráfico

    function loadChartData() {
      fetch('/api/graficos')
        .then(function (response) {
          if (!response.ok) {
            throw new Error('Erro ao obter os dados da API');
          }
          return response.json();
        })
        .then(function (data) {
          data.forEach(item => {
            const monthNumber = new Date(item.time_utc).getMonth() + 1;
            const month = monthNumber.toString().padStart(2, '0'); // Formato de dois dígitos, por exemplo, '01', '02', ..., '12'
            const type = item.type;

            if (!chartData[month]) {
              chartData[month] = {};
            }

            if (!chartData[month][type]) {
              chartData[month][type] = 0;
            }

            chartData[month][type]++;
          });

          updateChartByMonth(''); // Mostrar o gráfico inicialmente com todos os meses
        })
        .catch(function (error) {
          console.error(error);
        });
    }

    function getDescription(types, quantities) {
      let description = '';

      for (let i = 0; i < types.length; i++) {
        const type = types[i];
        const quantity = quantities[i];

        description += `Tipo ${type}: Quantidade ${quantity}<br>`;
      }

      return description;
    }

    function getMonthName(monthNumber) {
      const monthNames = [
        'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
        'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
      ];
      return monthNames[monthNumber - 1];
    }

    // Função para atualizar o gráfico de acordo com o mês selecionado
    function updateChartByMonth(selectedMonth) {
      const chartContainer = document.getElementById('chartContainer');

      // Limpar o conteúdo anterior do gráfico
      chartContainer.innerHTML = '';

      const orderedMonths = Object.keys(chartData).sort((a, b) => parseInt(a) - parseInt(b));

      for (const month of orderedMonths) {
        // Verificar se o mês selecionado corresponde ao mês atual no loop
        if (selectedMonth === '' || selectedMonth === month) {
          const monthName = getMonthName(parseInt(month));

          const types = Object.keys(chartData[month]);
          const quantities = Object.values(chartData[month]);

          const chartDiv = document.createElement('div');
          chartDiv.classList.add('chart-container');
          chartContainer.appendChild(chartDiv);

          const canvas = document.createElement('canvas');
          chartDiv.appendChild(canvas);

          const descriptionDiv = document.createElement('div');
          descriptionDiv.innerHTML = getDescription(types, quantities);
          chartDiv.appendChild(descriptionDiv);

          new Chart(canvas, {
            type: 'bar',
            data: {
              labels: types,
              datasets: [{
                label: monthName,
                data: quantities,
                backgroundColor: 'rgba(54, 162, 235, 0.5)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 2 // Reduza o valor para diminuir a largura das barras
              }]
            },
            options: {
              responsive: true,
              scales: {
                y: {
                  beginAtZero: true
                }
              }
            }
          });
        }
      }
    }

    // Adicione um evento de mudança no seletor de meses
    document.getElementById('monthSelect').addEventListener('change', function () {
      const selectedMonth = this.value;
      updateChartByMonth(selectedMonth);
    });

    window.onload = function () {
      loadChartData();
    };
  </script>
</body>
</html>
